@using System.ComponentModel
@using TableHelper.Models
@using TableHelper.Models.Npc
@using TableHelper.Services
@inject XwnNpcApiService XwnNpcApiService
@inject ToastService ToastService

<div class="row row-cols-2">
    @if (!Npcs.Any())
    {
        <p>No NPCs to show</p>
    }
    else
    {
        @foreach (var savedNpc in Npcs)
        {
            var npc = savedNpc.Npc;
            var id = savedNpc.Id;
            <div class="col-6 mb-2">
                <NpcInfoCard 
                    Id="@id"
                    NpcInfo="npc" 
                    DeleteClicked="@(async () => await HandleDeleteClickedAsync(id))"
                    ShowSave="@false"
                    ShowDelete="@true"></NpcInfoCard>
            </div>
        }
    }
</div>

@code {
    [Parameter] public List<SavedNpc> Npcs { get; set; } = [];
    private const string SuccessToastMessage = "Successfully deleted NPC.";
    private const string FailedToastMessage = "Failed to delete NPC.";

    private async Task HandleDeleteClickedAsync(int npcId)
    {
        var npcToDelete = Npcs.FirstOrDefault(n => n.Id == npcId);
        if (npcToDelete is not null)
        {
            await DeleteNpc(npcToDelete);
        }
    }

    private async Task DeleteNpc(SavedNpc npcToDeleteIndex)
    {
        var isDeleted = await XwnNpcApiService.DeleteXwnNpc(npcToDeleteIndex.Id);
        if (isDeleted)
        {
            Npcs.Remove(npcToDeleteIndex);
            await ToastService.ShowToast(ShowToastRequest.Success(SuccessToastMessage));
        }
        else
        {
            await ToastService.ShowToast(ShowToastRequest.Failure(FailedToastMessage));
        }
    }
}
