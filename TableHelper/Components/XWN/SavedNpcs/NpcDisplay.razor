@using TableHelper.Models
@using TableHelper.Models.Npc
@using TableHelper.Services
@inject XwnNpcApiService XwnNpcApiService
@inject ToastService ToastService

<NpcColumnDisplay
    DisplayRequests="DisplayNpcRequests"
    DeleteNpc="HandleDeleteClickedAsync"
    IsSaved="IsSaved"
    UseDynamicColumns="true"
/>

@code {
    [Parameter] public List<SavedNpc> Npcs { get; set; } = [];
    private List<DisplayNpcRequest> DisplayNpcRequests => Npcs.Select(n => new DisplayNpcRequest { Id = n.Id, NpcInfo = n.Npc }).ToList();
    private const string SuccessToastMessage = "Successfully deleted NPC.";
    private const string FailedToastMessage = "Failed to delete NPC.";

    private bool IsSaved(int id)
    {
        return Npcs.Exists(n => n.Id == id);
    }

    private async Task HandleDeleteClickedAsync(int npcId)
    {
        var npcToDelete = Npcs.FirstOrDefault(n => n.Id == npcId);
        if (npcToDelete is not null)
        {
            await DeleteNpc(npcToDelete);
        }
    }

    private async Task DeleteNpc(SavedNpc npcToDeleteIndex)
    {
        var isDeleted = await XwnNpcApiService.DeleteXwnNpc(npcToDeleteIndex.Id);
        if (isDeleted)
        {
            Npcs.Remove(npcToDeleteIndex);
            await ToastService.ShowToast(ShowToastRequest.Success(SuccessToastMessage));
        }
        else
        {
            await ToastService.ShowToast(ShowToastRequest.Failure(FailedToastMessage));
        }
    }

}
