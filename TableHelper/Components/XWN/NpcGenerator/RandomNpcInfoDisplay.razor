@using TableHelper.Models
@using TableHelper.Models.Npc
@using TableHelper.Services
@inject GeneratorApiService GeneratorApiService
@inject XwnNpcApiService XwnNpcApiService
@inject ToastService ToastService

<NpcColumnDisplay
    DisplayRequests="_displayNpcRequests"
    SaveNpc="SaveNpc"
    DeleteNpc="DeleteNpc"
    IsSaved="IsSaved"
    UseDynamicColumns="UseDynamicColumns"
/>

@code {
    [Parameter] public int NumberOfNpcs { get; set; }
    [Parameter] public PreferredNameOrigin PreferredNameOrigin { get; set; }
    [Parameter] public NameGender PreferredNameGender { get; set; }
    [Parameter] public EventCallback LoadedNpcsCallback { get; init; }
    [Parameter] public bool UseDynamicColumns { get; set; }
    [Parameter] public int ThreeColumnMinWidth { get; set; } = 1500;
    [Parameter] public int TwoColumnMinWidth { get; set; } = 1300;
    private List<NpcInfo> _npcs = [];
    private Dictionary<int, SavedNpc> _savedNpcs = [];
    private List<DisplayNpcRequest> _displayNpcRequests = [];
    private const string SuccessfullyDeletedNpcToastMessage = "Successfully deleted npc";
    private const string FailedToDeleteNpcToastMessage = "Failed to delete npc";
    private const string SuccessfullySavedNpcToastMessage = "Successfully saved npc";
    private const string FailedToSavedNpcToastMessage = "Failed to save npc";

    public async Task GenerateNpcs()
    {
        _npcs = [];
        _savedNpcs = [];
        _displayNpcRequests = [];
        _npcs = await GeneratorApiService.GetGeneratedNpcs(NumberOfNpcs, PreferredNameGender, PreferredNameOrigin);
        for (var i = 0; i < _npcs.Count; i++)
        {
            var request = new DisplayNpcRequest { Id = i, NpcInfo = _npcs[i] };
            _displayNpcRequests.Add(request);
        }

        await InvokeAsync(StateHasChanged);
        await LoadedNpcsCallback.InvokeAsync();
    }

    private bool IsSaved(int id)
    {
        return _savedNpcs.ContainsKey(id);
    }

    private async Task DeleteNpc(int npcToDeleteIndex)
    {
        var npc = _savedNpcs[npcToDeleteIndex];
        var isDeleted = await XwnNpcApiService.DeleteXwnNpc(npc.Id);
        if (isDeleted)
        {
            _savedNpcs.Remove(npcToDeleteIndex);
            await ToastService.ShowToast(ShowToastRequest.Success(SuccessfullyDeletedNpcToastMessage));
        }
        else
        {
            await ToastService.ShowToast(ShowToastRequest.Failure(FailedToDeleteNpcToastMessage));
        }

        _savedNpcs.Remove(npcToDeleteIndex);
    }

    private async Task SaveNpc(int npcToSavesIndex)
    {
        var npc = _npcs[npcToSavesIndex];
        var savedNpc = await XwnNpcApiService.SaveXwnNpc(npc);
        if (savedNpc == null)
        {
            await ToastService.ShowToast(ShowToastRequest.Failure(FailedToSavedNpcToastMessage));
        }
        else
        {
            _savedNpcs.Add(npcToSavesIndex, savedNpc);
            await ToastService.ShowToast(ShowToastRequest.Success(SuccessfullySavedNpcToastMessage));
        }
    }

}